version: '3'

services:
  consul:
    image: "consul-dev"
    command:
     - "agent"
     - "-dev"
     - "-config-dir"
     - "/etc/consul"
     - "-client"
     - "0.0.0.0"
    volumes:
      - "./etc/consul:/etc/consul"
    ports:
      # Exposing to host makes debugging locally a bit easier
      - "8500:8500"
      - "8502:8502"

  s1:
    depends_on:
      - consul
    image: "fortio/fortio"
    command:
     - "server"
     - "-http-port"
     - ":8080"
    network_mode: service:consul

  s2:
    depends_on:
      - consul
    image: "fortio/fortio"
    command:
     - "server"
     - "-http-port"
     - ":8181"
    network_mode: service:consul

  s1-sidecar-proxy:
    depends_on:
      - consul
    image: "envoyproxy/envoy:v${ENVOY_VERSION:-1.8.0}"
    command:
     - "envoy"
     - "-c"
     - "/etc/envoy/s1-bootstrap.json"
     - "-l"
     - "debug"
     # Hot restart breaks since both envoys seem to interact with each other
     # despite separate containers taht don't share IPC namespace. Not quire
     # sure how this happens but may be due to unix socket being in some shared
     # location?
     - "--disable-hot-restart"
     - "--drain-time-s"
     - "1"
    volumes:
      - "./etc/envoy:/etc/envoy"
    network_mode: service:consul

  s2-sidecar-proxy:
    depends_on:
      - consul
    image: "envoyproxy/envoy:v${ENVOY_VERSION:-1.8.0}"
    command:
     - "envoy"
     - "-c"
     - "/etc/envoy/s2-bootstrap.json"
     - "-l"
     - "debug"
     # Hot restart breaks since both envoys seem to interact with each other
     # despite separate containers taht don't share IPC namespace. Not quire
     # sure how this happens but may be due to unix socket being in some shared
     # location?
     - "--disable-hot-restart"
     - "--drain-time-s"
     - "1"
    volumes:
      - "./etc/envoy:/etc/envoy"
    network_mode: service:consul

  verify:
    depends_on:
      - consul
    build:
      context: .
      dockerfile: Dockerfile-bats
    tty: true
    command:
     - "--pretty"
     - "/etc/bats"
    volumes:
      - "./etc/bats:/etc/bats"
      - "./etc/statsd:/etc/statsd"
    network_mode: service:consul

  s1-sidecar-proxy-consul-exec:
    depends_on:
      - consul
    build:
      context: .
      dockerfile: Dockerfile-consul-envoy
      args:
        ENVOY_VERSION: ${ENVOY_VERSION:-1.8.0}
    command:
      - "consul"
      - "connect"
      - "envoy"
      - "-sidecar-for"
      - "s1"
    network_mode: service:consul

  fake-statsd:
    depends_on:
      - consul
    image: "alpine/socat"
    command:
      - UDP-RECVFROM:8125,fork
      - SYSTEM:'xargs -0 echo >> /etc/statsd/statsd.log'
    volumes:
      - "./etc/statsd:/etc/statsd"
    network_mode: service:consul
